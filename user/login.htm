<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="images/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />

  <title>Login</title>

  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com"/>
  <link rel="preconnect" href="https://cdn.tailwindcss.com" />
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin/>
	<script src="https://cdn.tailwindcss.com"></script>

  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net"/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin/>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.27.2/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@leonardwoo/pika-js@0.1.6/dist/pika.min.js" defer></script>
    
  <link rel="preload" href="stylesheets/user.css" as="style">
  <link rel="stylesheet" type="text/css" href="stylesheets/user.css" />

</head>
<body>
  <div id="app" class="container mx-auto text-gray-800">
    <div class="min-h-screen flex justify-center items-center mx-auto w-auto">
      <div class="shadow-xl p-4 lg:p-8 bg-gray-50 rounded-xl relative select-none -mt-20 w-1/4">
        <div id="loginLogo" class="flex justify-center mb-1">
          <img src="/images/logo.svg" class="h-10 lg:h-16" />
        </div>
        <div id="loginTitle" class="flex justify-center mb-4 lg:mb-8">
          <span class="text-xl lg:text-3xl mt-1 text-gray-600">LOGIN</span>
        </div>
        <form id="loginForm">
          <!-- <input type="hidden" id="client_id" name="client_id" value="" />
          <input type="hidden" id="client_secret" name="client_secret" value="" /> -->
          <!-- <input type="hidden" id="grant_type" name="grant_type" value="password" /> -->
          <input type="hidden" name="csrf_token" value="" />
          <div class="relative text-gray-800 focus-within:text-gray-600 mb-2 lg:mb-4">
            <input type="text" name="username" placeholder="Username" id="username" 
              class="block px-2 lg:px-4 py-1 lg:py-2 w-full rounded bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:border-transparent" />
          </div>
          <div class="relative text-gray-800 focus-within:text-gray-600 mb-2 lg:mb-4">
            <input type="password" name="password" placeholder="Password" id="password" 
              class="block px-2 lg:px-4 py-1 lg:py-2 w-full rounded bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:border-transparent" />
          </div>
          <div class="relative flex justify-between text-gray-800 focus-within:text-gray-600 mb-4 lg:mb-6">
            <div class="flex items-center">
              <input id="remember-me" name="remember-me" type="checkbox" 
                class="h-4 w-4 relative rounded border-none ring-none focus:outline-none after:content-[''] appearance-none bg-gray-200 checked:bg-gray-800 ">
              <label for="remember-me" class="ml-2 block text-sm">Remember me</label>
            </div>
            <div id="enableForgotPassword" class="flex items-center">
              <a href="reset.htm" target="_blank" class="text-xs hover:text-blue-400">Forgot password?</a>
            </div>
          </div>
          <div class="flex items-center justify-center text-center mb-4 lg:mb-6">
            <button name="button" id="login" type="submit" class="btn bg-gray-600 hover:bg-gray-500 text-white py-1 lg:py-2 rounded-full w-full inline">Login</button>
          </div>
        </form>
        <div id="enableThirdPartyAuth" class="relative text-gray-800 focus-within:text-gray-600 mb-2 lg:mb-4">
          <div id="hr" class="my-4 relative text-center clear-both overflow-hidden
            before:content-[''] before:relative before:inline-block before:h-px before:bg-gray-200 before:align-middle before:right-2 before:w-1/2 before:-ml-1/2
            after:content-[''] after:relative after:inline-block after:h-px after:bg-gray-200 after:align-middle after:left-2 after:w-1/2 after:-mr-1/2">
            <span class="text-gray-400">OR</span>
          </div>
          <div id="thirdPartyAuthList" class="flex justify-center space-x-4">
            <div id="authBox" class="">
              <a href="#" id="authLink">
                <img src="images/Google_G_Logo.svg" id="authIcon" class="h-10 w-10" />
              </a>
            </div>
            <div id="authBox" class="">
              <a href="#" id="authLink">
                <img src="images/Github_Logo.svg" id="authIcon" class="h-10 w-10" />
              </a>
            </div>
            <div id="authBox" class="">
              <a href="#" id="authLink">
                <img src="images/Twitter_Blue_Logo.svg" id="authIcon" class="h-10 w-10" />
              </a>
            </div>
            <div id="authBox" class="">
              <a href="#" id="authLink">
                <img src="images/Microsoft_Logo.svg" id="authIcon" class="h-10 w-10" />
              </a>
            </div>
          </div>
        </div>
        <div id="enableSignUp" class="text-center text-xs pt-12 lg:pt-16 text-gray-400">
          <span class="">Donâ€™t have an account?</span>
          <a href="signup.htm" class="hover:text-blue-400" target="_blank">Sign Up</a>
        </div>
      </div>
    </div>
    <footer class="flex justify-center items-end -mt-10">
      <div class="text-center text-gray-50">
        <span>Copyright &copy; 2022 Leonard Woo</span>
      </div>
    </footer>
  </div>

  <!-- <script src="scripts/rsa.js" defer></script>
  <script>
function rsaEncrypted(text) {
  var publicKey;

  axios.get("http://127.0.0.1:8080/get_rsa_public_key")
  .then(function(response){
    publicKey = response.data.public_key;
  })
  .catch(function (error) {
    console.log(error);
  });

  var resultMessage = "";
  importPublicKeyAndEncrypt(publicKey, text)
  .then(function (msg) {
    resultMessage = msg;
  })
  .catch(function(error){
    console.log(error);
  });
  return resultMessage;
}
  </script> -->

  <script src="scripts/jwt.js" defer></script>
  <script>
"use strict";

window.addEventListener('load', (event) => {
  const user = localStorage.getItem('user');
  const redirectUrl = "/";
  const userJO = JSON.parse(user);
  if (userJO != null) {
    var token = userJO.token;
    if (token != null) {
      var payload = ParseJwtPayload(token);
      if (payload != null && !(((payload.iat + userJO.expire) * 1000) < Date.parse(new Date()))) {
        window.location.href = redirectUrl;
      }
    }
  }
  
  // console.log(window.location.pathname.endsWith("login.htm")? "1": "2");

  axios.defaults.headers.post['Access-Control-Allow-Origin'] = '*';
  axios.defaults.withCredentials = true;

  axios.get("http://127.0.0.1:8080/options")
  .then(function (response) {
    if(!response.data.enable_third_party_auth) {
      document.getElementById('enableThirdPartyAuth').remove();
    }
    if(!response.data.enable_signup) {
      document.getElementById('enableSignUp').remove();
    }
    if(!response.data.enable_forgot_password) {
      document.getElementById('enableForgotPassword').remove();
    }
  });

  document.getElementById('csrf_token').innerText = Cookies.get('csrftoken');

  // var clientid;
  // var clientsecret;
  // if (clientid == null || clientsecret == null) {
  //   axios.get("http://127.0.0.1:8080/auth/settings")
  //   .then(function (response) {
  //     clientid = response.data.clientid;
  //     clientsecret = response.data.clientsecret;
  //   })
  //   .catch(function (error) {
  //     console.log(error);
  //   });
  //   //
  // }

  // document.getElementById('client_id').setAttribute('value', clientid);
  // document.getElementById('client_secret').setAttribute('value', clientsecret);

});


document.getElementById("login").onclick = (event) => {
  axios.defaults.headers.post['Access-Control-Allow-Origin'] = '*';
  axios.defaults.withCredentials = true;
  // var clientId = document.getElementById("client_id").value;
  // var clientSecret = document.getElementById("client_secret").value;
  // var grantType = document.getElementById("grant_type").value;
  var csrfToken = document.getElementById("csrf_token").value;
  var username = document.getElementById("username").value;
  var password = document.getElementById("password").value;

  var formData = new FormData();
  // formData.append('client_id', clientId);
  // formData.append('client_secret', clientSecret);
  // formData.append('grant_type', grantType);
  formData.append('username', username);
  formData.append('password', password);
  
  // const formEncryptedData = rsaEncrypted(new URLSearchParams(formData).toString());

  axios.post("http://127.0.0.1:8080/login", formData, {
    // username: username,
    // password: password,
    headers: {
      "Content-Type": "multipart/form-data",
      "X-CSRF-TOKEN": csrfToken
    },
  })
  .then(function (response) {
    console.log(response.data);
    var user = {
      token: response.data.token,
      expire: response.data.expire_at,
    }
    localStorage.setItem('user', JSON.stringify(user));
  })
  .catch(function (error) {
    console.log(error);
  });
}
  </script>
</body>
</html>